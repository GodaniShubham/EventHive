<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - EventHive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            background-color: #f4f7fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', sans-serif;
        }

        .navbar {
            background-color: #1e3a8a;
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #0d9488;
            border-color: #0d9488;
        }

        .btn-primary:hover {
            background-color: #0b8276;
            border-color: #0b8276;
        }
    </style>
</head>

<body>
    <nav class="navbar text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{% url 'home' %}" class="text-2xl font-bold">EventHive</a>
            <div>
                {% if user.is_authenticated %}
                <a href="{% url 'logout' %}" class="text-white hover:underline">Logout</a>
                {% else %}
                <a href="{% url 'login' %}" class="text-white hover:underline mr-4">Login</a>
                <a href="{% url 'register' %}" class="text-white hover:underline">Register</a>
                {% endif %}
            </div>
        </div>
    </nav>

    {% if messages %}
    <div class="container mx-auto mt-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="min-h-screen flex items-center justify-center bg-gray-50 py-10">
        <div class="card bg-white p-8 w-full max-w-2xl">
            <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-8">ðŸ’³ Payment for {{ event.title }}</h2>
            <p class="text-center text-gray-500 mb-6">Total Amount: â‚¹{{ total_amount|div:100 }}</p>
            <button id="rzp-button"
                class="w-full btn-primary text-white font-semibold py-3 rounded-lg shadow-md transition">Pay
                Now</button>
        </div>
    </div>

    <footer class="bg-gray-900 text-white text-center p-4 mt-auto">
        <p>&copy; 2025 EventHive. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('rzp-button').onclick = function (e) {
            var options = {
                "key": "{{ razorpay_key }}",
                "amount": {{ total_amount }
        },
            "currency": "INR",
                "name": "EventHive",
                    "description": "Payment for {{ event.title }}",
                        "order_id": "{{ order_id }}",
                            "handler": function(response) {
                                fetch("{% url 'payment_success' event.id %}", {
                                    method: "POST",
                                    headers: {
                                        "X-CSRFToken": "{{ csrf_token }}",
                                        "Content-Type": "application/x-www-form-urlencoded"
                                    },
                                    body: `razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&razorpay_signature=${response.razorpay_signature}`
                                })
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.status === "success") {
                                            window.location.href = "{% url 'attendee_home' %}";
                                        } else {
                                            alert("Payment verification failed!");
                                        }
                                    })
                                    .catch(err => {
                                        console.error("Payment error:", err);
                                        alert("An error occurred during payment verification.");
                                    });
                            },
        "prefill": {
            "name": "{{ user.username }}",
                "email": "{{ user.email }}",
                    "contact": "{{ user.phone }}"
        },
        "theme": {
            "color": "#0d9488"
        }
                };
        try {
            var rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                alert("Payment failed: " + response.error.description);
                window.location.href = "{% url 'attendee_home' %}";
            });
            rzp1.open();
        } catch (err) {
            console.error("Razorpay initialization error:", err);
            alert("Failed to initialize payment. Please try again.");
        }
        e.preventDefault();
        };
    </script>
</body>

</html>